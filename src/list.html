<!DOCTYPE html>
<html>
<head>
    <title>Virtue / Vice</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../css/list.css">
    <link rel="stylesheet" type="text/css" href="../css/box.css">
    <link rel="stylesheet" href="../css/font-awesome-4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../css/log.css">
    <script src="../js/firebase.js"></script>
    <script src="../js/jquery.js"></script>
    <script src="../js/not.js"></script>
    <script src="../js/log.js"></script>
    
</head>
<body>
    <div class="notification-box" id="not">
        <div class="notification-message">
            <button type="button" class="close" onclick="end()">Ã—</button>
            <button type="button" class="settings" onclick="set()">
                <i class="fa fa-list-ol"></i>
            </button>
            <p>Come Check Back in on Your Habits!</p>
        </div>
    </div>    
    <div class="log-box" id="log">     
        <div class="log-message">
            <button type="button" class="log-button" onclick="logout_no()">NO</button>
            <button type="button" class="log-button" onclick="logout_yes()">YES</button>
            <p>Are you sure you want to log out?</p>
        </div>
    </div>     
    <section>
        <h1>Habit List</h1>
        <ul id="habit-list">
            
        </ul>     
    </section>
   
    
        
        /*******Global variables**************/
        //reference to firebase
        var myDataRef = new Firebase('https://jjb750uy9yj.firebaseio-demo.com/habits/');
        var progressData;
        
        function showMsg(element){
            var msgElement = (element.parentNode.parentNode.getElementsByClassName("message"))[0];
            
            var msgTotal = (msgElement.getElementsByTagName("svg"))[0];
            var lines = (msgElement.getElementsByTagName("line"));
            
            //Update the counter for the progress bar
            var habitKey = element.parentElement.parentElement.id;
            var habitProgressRef = myDataRef.child(habitKey + '/habitData/habitProgress/');
                  
            habitProgressRef.transaction(function(currentData)
            {
                //alert(JSON.stringify(currentData));
                var maxRecord = currentData.maxRecord;
                if(currentData.maxRecord <= currentData.counter + 1)
                {
                    var maxRecord = parseInt(currentData.maxRecord, 10) + parseInt(1, 10);
                }
                habitProgressRef.update({ counter: parseInt(currentData.counter, 10) + parseInt(1, 10) , maxRecord: maxRecord});
                alert(JSON.stringify(currentData));
            });
            
            // TODO algorithm to determine how much the line should increase
            if(parseInt(lines[0].getAttribute("x2")) < 150){
                lines[0].setAttribute("x2", parseInt(lines[0].getAttribute("x2"))+10);
                lines[1].setAttribute("x1", parseInt(lines[1].getAttribute("x1"))+10);
                // TODO also update the current number
            }
            
            msgElement.style.visibility="visible";
        }
        
        //Pauses the habit
        function pausePlayHabit(element){
            /* grab from database if it is play or pause. store as variable then check change play/pause */
            //alert(element.tagName);
            var thisList = (element.parentNode.parentNode);
            var habitElement = (thisList.getElementsByClassName("habit-op"))[0];
            
            //Get ref to update setting pause
            var habitKey = element.parentElement.parentElement.id;
            var settingsRef = myDataRef.child(habitKey + '/habitData/settings/');

            var button = habitElement.getElementsByTagName("button");
            event.stopPropagation();//stops event listener of parent nodes.
            
            //getting current state of habit, pause or unpaused
            var play;
            
            settingsRef.transaction(function(currentData)
            {
    
                if(currentData.pause === '1')          
                {
                    play = false;
                }
                else
                {
                    play = true;    
                }
            });
        
            if(play)
            {
                for(i=0;i<button.length;i++)
                {
                    button[i].setAttribute("disabled",true);
                }
                
                thisList.style.opacity = "0.5";
                element.src = "../img/play.png"; 
                play=false;
                
                settingsRef.transaction(function(currentData)
                {
                    settingsRef.update({pause: '1'});
                    //alert(JSON.stringify(currentData));   
                });
            }
            else
            {
                //alert('here');
                for(i=0;i<button.length;i++)
                {
                    button[i].removeAttribute("disabled");
                }
                
                thisList.style.opacity = "1";
                element.src = "../img/pause.jpe";
                play=true;
                
                settingsRef.transaction(function(currentData)
                {
                    settingsRef.update({pause: '0'});
                });
            }
        }

        //Deletes habit from page and Db
        function deleteHabit(element){
            var child = element.parentNode.parentNode;
            var parent = child.parentNode;
            
            //delete habit from DB
            var id = child.getAttribute('id');
            var deleteHabitRef = buildEndPoint(id);
            deleteHabitRef.remove();
                              
            parent.removeChild(child);
            
            //alert(parent.nodeName);    
        }
        
        function buildEndPoint (key) {
            return new Firebase('https://jjb750uy9yj.firebaseio-demo.com/habits/' + key);
        }
        
        var getKeys = function(obj){
           var keys = [];
           for(var key in obj){
              keys.push(key);
           }
           return keys;
        }
                    
        function editHabit (element){
            var habitId = element.parentNode.parentNode.id;
            document.location='edit.html?' + habitId;
        }
        
        function displayHabit(name, text, key, iconId, habitProgress) {
            
            $('#habit-list').append(
            
            '<li class=\"slider\" id=\"'+ key +'\">' +
                '<ul class=\"habit-info\">'+
                    '<li><div class=\"habit-name\">'+name+'</div></li>' +
                    '<li><img class=\"habit-icon\" src=\"../img/'+iconId+'\" alt=\"habit icon\"></li>'+
                '</ul>' +
                '<div class=\"message\">' +
                    '<span class=\"message-total\">' +
                        '<strong>48</strong> days in a row! Best Record: <strong>60</strong><br>' +
                        '<svg height=\"25\" width=\"150\">' +
                            '<line x1=\"0\" y1=\"0\" x2=\"'+((habitProgress['counter']/habitProgress['maxRecord']) * 150)+'\" y2=\"0\" style=\"stroke:rgba(65, 131, 215, 0.8);stroke-width:25\" />' +
                            '<line x1=\"'+((habitProgress['counter']/habitProgress['maxRecord']) * 150)+'\" y1=\"0\" x2=\"'+150+'\" y2=\"0\" style=\"stroke:rgba(171,171,171,0.6);stroke-width:25\" />' +
                        '</svg>' +
                    '</span><br>' +
                    '<span class=\"message-today\">Completed <strong>1/2</strong> for today!</span>' +
                '</div>' +
                '<div class=\"habit-op\">' +
                    '<button  type=\"button\" class=\"op op-done\" onclick=\"showMsg(this);\" title=\"done\">' +
                        '<img src=\"../img/done.svg\" alt=\"Done\">' +
                    '</button>' +
                    '<button type=\"button\" class=\"op op-edit\" onclick=\"editHabit(this);\" title=\"edit habit\">' +
                        '<img src=\"../img/edit.svg\" alt=\"Edit\">' +
                    '</button>' +
                    '<button type=\"button\" class=\"op op-del\" onclick=\"deleteHabit(this);\" title=\"delete habit\">' +
                        '<img src=\"../img/delete.svg\" alt=\"Del\">' +
                    '</button>' +
                '</div>' +
                '<div class=\"pause\" style=\"position:relative;left:545px;bottom:50px;display:none\">' +
                    //'<button type=\"button\" class=\"op op-pause\" onclick=\"pausePlayHabit(this);\" title=\"pause\">' +
                        '<img id=\"img'+key+'\" style=\"position:absolute; top: -60px;\" src=\"../img/pause.jpe\" alt=\"Pause\" height=\"150\" width=\"150\" onclick=\"pausePlayHabit(this);\">' +
                    //'</button>' +
                '</div>' +
            '</li>'            
            );
            //alert(JSON.stringify($('#'+key)));
            //return $('#'+key);
        };

        /*
        
        function displayPausedHabit(name, text, key, iconId, habitProgress) {
            
            $('#habit-list').append(
            
                
                <li class="slider" id="-K2tkyfzJG4mIHL9W7jz" style="opacity: 0.5; left: 0px;">
   <ul class="habit-info">
      <li>
         <div class="habit-name">Lift Weights</div>
      </li>
      <li><img class="habit-icon" src="../img/sleep.jpg" alt="habit icon"></li>
   </ul>
   <div class="message">
      <span class="message-total">
         <strong>48</strong> days in a row! Best Record: <strong>60</strong><br>
         <svg height="25" width="150">
            <line x1="0" y1="0" x2="150" y2="0" style="stroke:rgba(65, 131, 215, 0.8);stroke-width:25"></line>
            <line x1="150" y1="0" x2="150" y2="0" style="stroke:rgba(171,171,171,0.6);stroke-width:25"></line>
         </svg>
      </span>
      <br><span class="message-today">Completed <strong>1/2</strong> for today!</span>
   </div>
   <div class="habit-op"><button type="button" class="op op-done" onclick="showMsg(this);" title="done" disabled="true"><img src="../img/done.svg" alt="Done"></button><button type="button" class="op op-edit" onclick="editHabit(this);" title="edit habit" disabled="true"><img src="../img/edit.svg" alt="Edit"></button><button type="button" class="op op-del" onclick="deleteHabit(this);" title="delete habit" disabled="true"><img src="../img/delete.svg" alt="Del"></button></div>
   <div class="pause" style="position: relative; left: 545px; bottom: 50px; display: none;"><img id="img-K2tkyfzJG4mIHL9W7jz" style="position:absolute; top: -60px;" src="../img/play.png" alt="Pause" height="150" width="150" onclick="pausePlayHabit(this);"></div>
</li>
                      
            );
        };
        
        */
        

        $(document).ready(function() {
            
            //Keep a mapping of firebase locations to HTML elements in order to remove or move elements
            var habitObject = {};
            var habitList = [];
        
            //fired upon child added to
            myDataRef.on('child_added', function(snapshot) {
                var data = snapshot.val().habitData;
                var habitKey = snapshot.name();
                //alert(JSON.stringify(data));
                
                //saving progress data for counter updates when user confirms their habit for the day is complete
                
                if(data.hasOwnProperty('name')){
                    name = data.name ? data.name : '';
                    if(name.trim().length > 0)
                        {
                            habitList.push({key: habitKey, name: name});
                            habitObject[habitKey] = name;
                        }
                }
                
                //alert(data.settings.turnoff);
                if(data.settings.turnoff === '0')
                {
                    displayHabit(data.name, data.text, habitKey, data.iconId, data.habitProgress);
                    
                    //alert(data.settings.pause);
                    if(data.settings.pause === '1' )
                        {
                            //trigger pause style by calling twice
                            pausePlayHabit(document.getElementById('img'+habitKey));
                            pausePlayHabit(document.getElementById('img'+habitKey));
                        }
                }
            });
            
            //Makes slider go right
            $(document).on('click', '.habit-op', function(event){
                event.stopPropagation();
            });

            $(document).on('click', '.slider', function(evt){
                //alert("I got clicked!");
                var $pause = $(this).find(".pause");
                
                if($pause.css("display")=="none")
                {
                    $(this).animate({"left":"-=100px"}, "fast");
                    $(this).find(".pause").show("fast");   
                }
                else
                {
                    $(this).animate({"left":"+=100px"}, "fast");
                    $(this).find(".pause").hide("fast");  
                }
            });
        });
           
    </script>
    <div id="button-box">
        <button type="button" id="notification" title="view notification" onclick="window.location = 'setting.html'"><i class="fa fa-cog"></i></button>

        <button type="button" id="addHabit" onclick="location.href='add.html'" title="add habit">+</button>
            
        <button type="button" id="logout" onclick="logout_called()">LOGOUT</button> 

    </div>
</body>
</html>